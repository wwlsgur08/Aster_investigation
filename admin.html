<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASTER ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #f8fafc;
            color: #2d3748;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #667eea;
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #718096;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .panel-header {
            background: #f8fafc;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .panel-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .data-table th {
            background: #f8fafc;
            font-weight: bold;
            color: #4a5568;
        }
        
        .data-table tbody tr:hover {
            background: #f8fafc;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        
        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .category-bar {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .category-name {
            width: 150px;
            font-size: 12px;
            color: #4a5568;
        }
        
        .category-progress {
            flex: 1;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 10px;
        }
        
        .category-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        .category-count {
            font-weight: bold;
            color: #667eea;
            min-width: 30px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .survey-response {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        .response-meta {
            font-size: 12px;
            color: #718096;
            margin-bottom: 8px;
        }
        
        .response-text {
            color: #2d3748;
            line-height: 1.5;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        /* â–¼â–¼â–¼ ì´ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” â–¼â–¼â–¼ */
        .data-table tbody tr {
            cursor: pointer; /* ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì†ê°€ë½ ëª¨ì–‘ìœ¼ë¡œ ë³€ê²½ */
        }
        .data-table tbody tr.selected {
            background-color: #dbeafe !important; /* ì„ íƒëœ í–‰ì˜ ë°°ê²½ìƒ‰ */
            font-weight: bold;
        }
        .btn:disabled {
            background: #cbd5e1; /* ë¹„í™œì„±í™”ëœ ë²„íŠ¼ì˜ ë°°ê²½ìƒ‰ */
            cursor: not-allowed;
        }
        /* â–²â–²â–² ì—¬ê¸°ê¹Œì§€ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” â–²â–²â–² */
</style>
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ ASTER ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
            <p>ë§¤ë ¥ íƒêµ¬ í”„ë¡œê·¸ë¨ ë°ì´í„° ë¶„ì„ ë° ê´€ë¦¬</p>
        </div>
        
        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">-</div>
                <div class="stat-label">ì´ ì‚¬ìš©ì ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalSurveys">-</div>
                <div class="stat-label">ì„¤ë¬¸ ì‘ë‹µ ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgSatisfaction">-</div>
                <div class="stat-label">í‰ê·  ë§Œì¡±ë„</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completionRate">-</div>
                <div class="stat-label">ì™„ë£Œìœ¨</div>
            </div>
        </div>
        
        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="content-grid">
            <!-- ìµœê·¼ ì‚¬ìš©ì ë°ì´í„° -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">ğŸ“Š ìµœê·¼ ì‚¬ìš©ì ë°ì´í„° (ì‚­ì œí•  í•­ëª© í´ë¦­)</div>
                </div>
                <div class="panel-content" id="recentUsers">
                    <div class="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                </div>
            </div>
            
            <!-- ë§¤ë ¥ ì¹´í…Œê³ ë¦¬ í†µê³„ -->
            <div class="panel">
                <div class="panel-header">
    <div class="panel-title">â±ï¸ ë‹¨ê³„ë³„ í‰ê·  ê³ ë¯¼ ì‹œê°„</div>
</div>
                <div class="panel-content" id="categoryStats">
                    <div class="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                </div>
            </div>
            
            <!-- ì„¤ë¬¸ ì‘ë‹µ ë¶„ì„ -->
            <div class="panel full-width">
                <div class="panel-header">
                    <div class="panel-title">ğŸ“ ì„¤ë¬¸ì¡°ì‚¬ ì‘ë‹µ ë¶„ì„</div>
                </div>
                <div class="panel-content" id="surveyAnalysis">
                    <div class="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>
        
        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="refreshData()">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn" onclick="exportData()">ğŸ“¥ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
            <button class="btn" id="deleteButton" onclick="deleteSelectedData()" style="background: #e53e3e;" disabled>ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ</button>
        </div>
    </div>

    <!-- Firebase ì„¤ì • -->
<!-- Firebase ì„¤ì • -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc, orderBy, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA5bHCxTRXx05hyZ8sKZZ4MB5pDdkboD6g",
        authDomain: "aster-423c7.firebaseapp.com",
        projectId: "aster-423c7",
        storageBucket: "aster-423c7.firebasestorage.app",
        messagingSenderId: "1091386634099",
        appId: "1:1091386634099:web:2562deb2939b933e691f06",
        measurementId: "G-DZHTQLB0L0"
    };

    // Firebase ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ì „ì—­ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ window ê°ì²´ì— ì¶”ê°€
    window.db = db;
    window.collection = collection;
    window.getDocs = getDocs;
    window.deleteDoc = deleteDoc;
    window.doc = doc;
    window.orderBy = orderBy;
    window.query = query;
    
    console.log("Firebase ì´ˆê¸°í™” ì™„ë£Œ!");
    
    // Firebase ì¤€ë¹„ ì™„ë£Œ í‘œì‹œ
    window.firebaseReady = true;
</script>

<!-- admin.jsë¥¼ ë¨¼ì € ë¡œë“œ -->
<script src="js/admin.js"></script>

<!-- Firebaseì™€ admin.js ëª¨ë‘ ì¤€ë¹„ëœ í›„ ëŒ€ì‹œë³´ë“œ ì‹œì‘ -->
<!-- ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ë¶€ë¶„ ë’¤ì— ì´ ì½”ë“œë¥¼ ì¶”ê°€: -->

<!-- ê¸°ì¡´ loadDashboardData í•¨ìˆ˜ ë¶€ë¶„ì„ ì´ë ‡ê²Œ ìˆ˜ì •: -->

<script>
// ì„ì‹œë¡œ í•„ìš”í•œ í•¨ìˆ˜ë“¤ì„ ì§ì ‘ ì¶”ê°€
// ì „ì—­ ë°ì´í„° ë°°ì—´
let userData = [];
let surveyData = [];
// ì„ íƒëœ ì‚¬ìš©ì IDë¥¼ ì €ì¥í•©ë‹ˆë‹¤. (ê¸°ì¡´ ë³€ìˆ˜ í™œìš©, ë‹¨ì¼ ì„ íƒìœ¼ë¡œ ë¡œì§ ë³€ê²½)
let selectedUserIds = new Set();

async function loadDashboardData() {
    console.log('ğŸ“Š ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë”© ì‹œì‘...');
    
    try {
        const ref = window.collection(window.db, 'complete_responses');
        const snapshot = await window.getDocs(ref);
        
        userData = [];
        surveyData = [];
        
        if (!snapshot.empty) {
            snapshot.forEach((doc) => {
                const data = doc.data();
                userData.push({ id: doc.id, ...data });
                if (data.survey_responses && Object.keys(data.survey_responses).length > 0) {
                    surveyData.push({ id: doc.id, ...data, ...data.survey_responses });
                }
            });
        }
        
        console.log(`ğŸ‘¥ ì‚¬ìš©ì ë°ì´í„°: ${userData.length}ê°œ`);
        console.log(`ğŸ“ ì„¤ë¬¸ ë°ì´í„°: ${surveyData.length}ê°œ`);
        
        // [ìˆ˜ì •] ëŒ€ì‹œë³´ë“œ ì „ì²´ë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
        rerenderDashboard();
        
        console.log('âœ… ëŒ€ì‹œë³´ë“œ ë¡œë”© ì™„ë£Œ!');
        
    } catch (error) {
        console.error('âŒ ëŒ€ì‹œë³´ë“œ ë¡œë”© ì‹¤íŒ¨:', error);
        alert('ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

// [ì‹ ê·œ] ëŒ€ì‹œë³´ë“œ ì „ì²´ë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
function rerenderDashboard() {
    // ì„ íƒëœ IDê°€ ìˆìœ¼ë©´ í•´ë‹¹ IDë¥¼ ê°€ì ¸ì˜¤ê³ , ì—†ìœ¼ë©´ null ì…ë‹ˆë‹¤.
    const filteredUserId = selectedUserIds.size > 0 ? selectedUserIds.values().next().value : null;

    // ì„ íƒëœ ì‚¬ìš©ìì— ë”°ë¼ í•„í„°ë§ëœ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    const finalUserData = filteredUserId ? userData.filter(u => u.id === filteredUserId) : userData;
    const finalSurveyData = filteredUserId ? surveyData.filter(s => s.id === filteredUserId) : surveyData;

    updateStatistics(finalUserData, finalSurveyData);
    renderRecentUsers(); // ì‚¬ìš©ì ëª©ë¡ì€ í•­ìƒ ì „ì²´ë¥¼ ë³´ì—¬ì£¼ë˜, ì„ íƒëœ í•­ëª©ì„ í‘œì‹œí•©ë‹ˆë‹¤.
    renderCategoryStats(finalUserData);
    renderSurveyAnalysis(finalSurveyData);
    updateDeleteButtonState();
}


function updateStatistics(currentUsers, currentSurveys) {
    document.getElementById('totalUsers').textContent = currentUsers.length;
    document.getElementById('totalSurveys').textContent = currentSurveys.length;
    
    if (currentSurveys.length > 0) {
        const satisfactionScores = currentSurveys
            .map(survey => parseInt(survey.overall_satisfaction || survey.satisfaction))
            .filter(score => !isNaN(score));
        
        if (satisfactionScores.length > 0) {
            const avgSatisfaction = satisfactionScores.reduce((a, b) => a + b, 0) / satisfactionScores.length;
            document.getElementById('avgSatisfaction').textContent = avgSatisfaction.toFixed(1);
        } else {
            document.getElementById('avgSatisfaction').textContent = '-';
        }
    } else {
        document.getElementById('avgSatisfaction').textContent = '-';
    }
    
    if (userData.length > 0) { // ì™„ë£Œìœ¨ì€ ì „ì²´ ì‚¬ìš©ì ëŒ€ë¹„ë¡œ ê³„ì‚°
        const completionRate = (surveyData.length / userData.length * 100);
        document.getElementById('completionRate').textContent = `${completionRate.toFixed(1)}%`;
    } else {
        document.getElementById('completionRate').textContent = '-';
    }
}

function renderRecentUsers() {
    const container = document.getElementById('recentUsers');
    
    if (userData.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #718096; padding: 40px;">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    
    const recentUsers = userData.slice(0, 10);
    let html = '<table class="data-table"><thead><tr><th>ë“±ë¡ ì‹œê°„</th><th>ì‚¬ìš©ì ID</th><th>ìƒíƒœ</th></tr></thead><tbody>';
    
    recentUsers.forEach(user => {
        const timestamp = user.timestamp ? new Date(user.timestamp).toLocaleString('ko-KR') : '-';
        const userId = user.userId || user.id || '-';
        const hasSurvey = surveyData.some(s => s.userId === user.userId);
        const status = hasSurvey ? 'âœ… ì™„ë£Œ' : (user.completed ? 'â³ í…ŒìŠ¤íŠ¸ ì™„ë£Œ' : 'ğŸ”„ ì§„í–‰ì¤‘');
        
        // [ìˆ˜ì •] ì„ íƒ ì—¬ë¶€ì— ë”°ë¼ 'selected' í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
        const isSelected = selectedUserIds.has(user.id) ? 'selected' : '';
        html += `<tr class="${isSelected}" onclick="toggleUserSelection(this, '${user.id}')"><td>${timestamp}</td><td style="font-family: monospace; font-size: 12px;">${userId}</td><td>${status}</td></tr>`;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function renderCategoryStats(currentUsers) {
    const container = document.getElementById('categoryStats');
    
    if (currentUsers.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #718096; padding: 40px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    
    let stage1Times = [], stage2Times = [], stage3Times = [];
    
    currentUsers.forEach(user => {
        if (user.stage1_duration && typeof user.stage1_duration === 'number' && user.stage1_duration > 0) stage1Times.push(user.stage1_duration);
        if (user.stage2_duration && typeof user.stage2_duration === 'number' && user.stage2_duration > 0) stage2Times.push(user.stage2_duration);
        if (user.stage3_duration && typeof user.stage3_duration === 'number' && user.stage3_duration > 0) stage3Times.push(user.stage3_duration);
    });
    
    function calculateAverage(times) {
        if (times.length === 0) return 0;
        return times.reduce((sum, time) => sum + time, 0) / times.length;
    }
    
    function formatTime(seconds) {
        if (seconds === 0) return '-';
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}ë¶„ ${remainingSeconds}ì´ˆ`;
    }
    
    const avg1 = calculateAverage(stage1Times);
    const avg2 = calculateAverage(stage2Times);
    const avg3 = calculateAverage(stage3Times);
    
    // (ì´í•˜ HTML ìƒì„± ì½”ë“œëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ë¯€ë¡œ ìƒëµ)
    // ... ê¸°ì¡´ renderCategoryStatsì˜ HTML ìƒì„± ë¡œì§ ...
     let html = `
        <div style="space-y: 20px;">
            <h4 style="margin-bottom: 20px; color: #4a5568;">â±ï¸ ë‹¨ê³„ë³„ í‰ê·  ê³ ë¯¼ ì‹œê°„</h4>
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #667eea;">
                    <div>
                        <div style="font-weight: bold; color: #2d3748;">1ë‹¨ê³„ (ë§¤ë ¥ ì¹´í…Œê³ ë¦¬ ì„ íƒ)</div>
                        <div style="font-size: 12px; color: #718096;">${stage1Times.length}ëª… ë°ì´í„°</div>
                    </div>
                    <div style="font-size: 24px; font-weight: bold; color: #667eea;">${formatTime(avg1)}</div>
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #38b2ac;">
                    <div>
                        <div style="font-weight: bold; color: #2d3748;">2ë‹¨ê³„ (ìƒí™©&ì„±í–¥ ì§ˆë¬¸)</div>
                        <div style="font-size: 12px; color: #718096;">${stage2Times.length}ëª… ë°ì´í„°</div>
                    </div>
                    <div style="font-size: 24px; font-weight: bold; color: #38b2ac;">${formatTime(avg2)}</div>
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #9f7aea;">
                    <div>
                        <div style="font-weight: bold; color: #2d3748;">3ë‹¨ê³„ (ì‹¬ì¸µ ì„±ì°°)</div>
                        <div style="font-size: 12px; color: #718096;">${stage3Times.length}ëª… ë°ì´í„°</div>
                    </div>
                    <div style="font-size: 24px; font-weight: bold; color: #9f7aea;">${formatTime(avg3)}</div>
                </div>
            </div>
            <div style="background: #edf2f7; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">ì „ì²´ í‰ê·  ì†Œìš” ì‹œê°„</div>
                <div style="font-size: 28px; font-weight: bold; color: #4a5568;">${formatTime(avg1 + avg2 + avg3)}</div>
            </div>
        </div>
    `;
    container.innerHTML = html;
}

function renderSurveyAnalysis(currentSurveys) {
    const container = document.getElementById('surveyAnalysis');
    
    if (currentSurveys.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #718096; padding: 40px;">ì„¤ë¬¸ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    // ì§ˆë¬¸ë³„ ë§Œì¡±ë„ ë¶„ì„ì„ ìœ„í•œ í•„ë“œ ì •ì˜
    const questionFields = [
        { key: 'overall_satisfaction', label: 'ì „ë°˜ì  ë§Œì¡±ë„' },
        { key: 'discovery_help', label: 'ë§¤ë ¥ ë°œê²¬ ë„ì›€ë„' },
        { key: 'recommendation', label: 'ì¶”ì²œ ì˜í–¥' },
        { key: 'stage1_rating', label: '1ë‹¨ê³„ í‰ê°€' },
        { key: 'stage2_rating', label: '2ë‹¨ê³„ í‰ê°€' },
        { key: 'stage3_rating', label: '3ë‹¨ê³„ í‰ê°€' },
        { key: 'onboarding_rating', label: 'ì˜¨ë³´ë”© ë©”ì‹œì§€ ìœ ìš©ì„±' },
        { key: 'skip_option_rating', label: 'ê±´ë„ˆë›°ê¸° ì˜µì…˜ ìœ ìš©ì„±' },
        { key: 'example_rating', label: 'ë‹µë³€ ì˜ˆì‹œ ìœ ìš©ì„±' },
        { key: 'template_rating', label: 'ê¸€ì“°ê¸° í…œí”Œë¦¿ ìœ ìš©ì„±' },
        { key: 'keywords_rating', label: 'í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ ìœ ìš©ì„±' },
        { key: 'understanding_improvement', label: 'ìê¸° ì´í•´ í–¥ìƒ' },
        { key: 'positivity_improvement', label: 'ê¸ì •ì  ì‚¬ê³  ê°œì„ ' }
    ];
    
    // ì£¼ê´€ì‹ í”¼ë“œë°±ì„ ìœ„í•œ í•„ë“œ ì •ì˜ (ì´ ë¶€ë¶„ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤)
    const feedbackFields = [
        { key: 'positive_experience', label: 'ê¸ì •ì  ê²½í—˜' },
        { key: 'understanding_reason', label: 'ìê¸° ì´í•´ ì´ìœ ' },
        { key: 'development_suggestion', label: 'ë°œì „ ì œì•ˆ' },
        { key: 'needs_improvement', label: 'ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„' },
        { key: 'improvement_reason', label: 'ê°œì„  í•„ìš” ì´ìœ ' }
    ];
    
    let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
    
    // ì™¼ìª½: ì§ˆë¬¸ë³„ ë§Œì¡±ë„ ë¶„í¬
    html += '<div>';
    html += '<h4 style="margin-bottom: 15px; color: #4a5568;">ğŸ“Š ì§ˆë¬¸ë³„ í‰ê·  ë§Œì¡±ë„</h4>';
    
    questionFields.forEach(field => {
        const scores = currentSurveys
            .map(survey => parseInt(survey[field.key]))
            .filter(score => !isNaN(score) && score >= 1 && score <= 5);
        
        if (scores.length > 0) {
            const average = scores.reduce((sum, score) => sum + score, 0) / scores.length;
            const percentage = (average / 5) * 100;
            
            html += `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 12px; font-weight: 500;">${field.label}</span>
                        <span style="font-size: 12px; font-weight: bold; color: #667eea;">${average.toFixed(1)}ì  (${scores.length}ëª…)</span>
                    </div>
                    <div style="height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                        <div style="height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: ${percentage}%; border-radius: 5px; transition: width 0.3s ease;"></div>
                    </div>
                </div>
            `;
        }
    });
    
    html += '</div>';
    
    // ì˜¤ë¥¸ìª½: ì§ˆë¬¸ë³„ ì£¼ê´€ì‹ í”¼ë“œë°± (ëˆ„ë½ë˜ì—ˆë˜ ë²„íŠ¼ ìƒì„± ë¡œì§)
    html += '<div>';
    html += '<h4 style="margin-bottom: 15px; color: #4a5568;">ğŸ’¬ ì§ˆë¬¸ë³„ ì£¼ê´€ì‹ í”¼ë“œë°±</h4>';
    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';

    feedbackFields.forEach(field => {
        const feedbacks = currentSurveys
            .map(survey => ({
                feedback: survey[field.key],
                timestamp: survey.timestamp,
                userId: survey.userId
            }))
            .filter(item => item.feedback && item.feedback.trim());
        
        html += `
            <button onclick="showFeedbackModal('${field.key}', '${field.label}')" 
                    style="padding: 15px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s ease;"
                    onmouseover="this.style.background='#edf2f7'"
                    onmouseout="this.style.background='#f8fafc'">
                <div style="font-weight: bold; color: #4a5568; margin-bottom: 5px;">${field.label}</div>
                <div style="font-size: 24px; font-weight: bold; color: #667eea;">${feedbacks.length}ê°œ</div>
                <div style="font-size: 12px; color: #718096;">ì‘ë‹µ ë³´ê¸°</div>
            </button>
        `;
    });

    html += '</div>'; // grid ë‹«ê¸°
    html += '</div>'; // ì˜¤ë¥¸ìª½ div ë‹«ê¸°
    html += '</div>'; // ì „ì²´ div ë‹«ê¸°
    
    container.innerHTML = html;
}
function refreshData() {
    console.log('ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨...');
    selectedUserIds.clear(); // ìƒˆë¡œê³ ì¹¨ ì‹œ ì„ íƒ í•´ì œ
    loadDashboardData();
}

function exportData() {
    alert('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
}

// [ìˆ˜ì •] ì‚¬ìš©ìë¥¼ í´ë¦­í–ˆì„ ë•Œì˜ ë™ì‘ì„ ë‹¨ì¼ ì„ íƒ í•„í„°ë§ìœ¼ë¡œ ë³€ê²½
function toggleUserSelection(rowElement, userId) {
    // ì´ë¯¸ ì„ íƒëœ IDì¸ì§€ í™•ì¸
    const isSelected = selectedUserIds.has(userId);

    // ëª¨ë“  ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
    document.querySelectorAll('#recentUsers .data-table tbody tr').forEach(tr => tr.classList.remove('selected'));
    selectedUserIds.clear();

    if (!isSelected) {
        // ì´ì „ì— ì„ íƒë˜ì§€ ì•Šì•˜ë‹¤ë©´, ìƒˆë¡œ ì„ íƒ
        selectedUserIds.add(userId);
        rowElement.classList.add('selected');
    }
    // ì´ë¯¸ ì„ íƒëœ ìƒíƒœì˜€ë‹¤ë©´, clear()ì— ì˜í•´ ì„ íƒì´ í•´ì œë¨

    // ëŒ€ì‹œë³´ë“œ ì „ì²´ë¥¼ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
    rerenderDashboard();
}

// [ìˆ˜ì •] ì‚­ì œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateDeleteButtonState() {
    const deleteButton = document.getElementById('deleteButton');
    const count = selectedUserIds.size;

    if (count > 0) {
        deleteButton.disabled = false;
        // í…ìŠ¤íŠ¸ë¥¼ "ì„ íƒí•œ 1ê°œ ë°ì´í„° ì‚­ì œ"ë¡œ ê³ ì •í•˜ê±°ë‚˜, ë” ëª…í™•í•˜ê²Œ ë³€ê²½ ê°€ëŠ¥
        deleteButton.textContent = `ğŸ—‘ï¸ ì„ íƒí•œ ë°ì´í„° ì‚­ì œ`;
    } else {
        deleteButton.disabled = true;
        deleteButton.textContent = 'ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ';
    }
}

// [ìˆ˜ì •] ì„ íƒëœ ë‹¨ì¼ ë°ì´í„° ì‚­ì œ
async function deleteSelectedData() {
    if (selectedUserIds.size === 0) return;

    const userIdToDelete = selectedUserIds.values().next().value;
    if (!confirm(`ì •ë§ë¡œ ì„ íƒí•œ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ID: ${userIdToDelete})`)) {
        return;
    }

    const deleteButton = document.getElementById('deleteButton');
    deleteButton.disabled = true;
    deleteButton.textContent = 'ì‚­ì œ ì¤‘...';

    try {
        await window.deleteDoc(window.doc(window.db, 'complete_responses', userIdToDelete));
        alert(`ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        
        selectedUserIds.clear(); // ì‚­ì œ í›„ ì„ íƒ í•´ì œ
        loadDashboardData(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    } catch (error) {
        console.error("ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨:", error);
        alert("ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        updateDeleteButtonState();
    }
}

function startDashboard() {
    if (window.firebaseReady && window.db) {
        console.log('ğŸš€ ëŒ€ì‹œë³´ë“œ ì‹œì‘!');
        loadDashboardData();
    } else {
        console.log('â³ Firebase ì¤€ë¹„ ëŒ€ê¸° ì¤‘...');
        setTimeout(startDashboard, 100);
    }
}

// í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í›„ ì‹œì‘
window.addEventListener('load', startDashboard);

// ğŸ”¥ í”¼ë“œë°± ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
// ğŸ”¥ í”¼ë“œë°± ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜ (ìˆ˜ì •ë¨)
function showFeedbackModal(fieldKey, fieldLabel) {
    // 1. í˜„ì¬ ì„ íƒëœ ì‚¬ìš©ìê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    const filteredUserId = selectedUserIds.size > 0 ? selectedUserIds.values().next().value : null;

    // 2. ì„ íƒëœ ì‚¬ìš©ìê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì‚¬ìš©ì ë°ì´í„°ë§Œ, ì—†ìœ¼ë©´ ì „ì²´ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    const dataSource = filteredUserId ? surveyData.filter(s => s.id === filteredUserId) : surveyData;

    // 3. ìœ„ì—ì„œ ê²°ì •ëœ ë°ì´í„° ì†ŒìŠ¤(dataSource)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í”¼ë“œë°±ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
    const feedbacks = dataSource
        .map(survey => ({
            feedback: survey[fieldKey],
            timestamp: survey.timestamp,
            userId: survey.userId
        }))
        .filter(item => item.feedback && item.feedback.trim());
    
    // 4. ì¶”ì¶œëœ í”¼ë“œë°±ìœ¼ë¡œ ëª¨ë‹¬ì°½ì˜ HTMLì„ ìƒì„±í•©ë‹ˆë‹¤. (ì´í•˜ ë¡œì§ì€ ê¸°ì¡´ê³¼ ë™ì¼)
    let modalHtml = `
        <div id="feedbackModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; width: 80%; max-width: 600px; max-height: 80%; border-radius: 10px; overflow: hidden;">
                <div style="background: #667eea; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h3>ğŸ’¬ ${fieldLabel} - ì „ì²´ ì‘ë‹µ (${feedbacks.length}ê°œ)</h3>
                    <button onclick="closeFeedbackModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">Ã—</button>
                </div>
                <div style="padding: 20px; max-height: 500px; overflow-y: auto;">
    `;
    
    if (feedbacks.length === 0) {
        modalHtml += '<div style="text-align: center; color: #718096; padding: 40px;">ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    } else {
        feedbacks.forEach((item, index) => {
            const timestamp = item.timestamp ? new Date(item.timestamp).toLocaleString('ko-KR') : '-';
            modalHtml += `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #667eea;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-size: 12px; color: #718096;">ğŸ‘¤ ${item.userId || 'Unknown'}</span>
                        <span style="font-size: 12px; color: #718096;">ğŸ“… ${timestamp}</span>
                    </div>
                    <div style="color: #2d3748; line-height: 1.6;">"${item.feedback}"</div>
                </div>
            `;
        });
    }
    
    modalHtml += `
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}
// ğŸ”¥ í”¼ë“œë°± ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
function closeFeedbackModal() {
    const modal = document.getElementById('feedbackModal');
    if (modal) {
        modal.remove();
    }
}
</script>

</body>
</html>